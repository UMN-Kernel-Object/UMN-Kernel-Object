<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Creating a Rust Hello World Module &mdash; UMN Kernel Object  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Creating a Simple Encryption Module" href="caesar_module.html" />
    <link rel="prev" title="Creating a Hello World Kernel Module" href="hello_world_module.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            UMN Kernel Object
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../UKO/index.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sched/index.html">Schedulers Subgroup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Rust Subgroup</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="rust.html">Rust Subgroup Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="hello_world_module.html">Creating a Hello World Kernel Module</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Creating a Rust Hello World Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="caesar_module.html">Creating a Simple Encryption Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="2023-11-08/index.html">Lifetimes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../maize/index.html">Maize information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virtmem/index.html">Virtual Memory Subgroup</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UMN Kernel Object</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Rust Subgroup</a></li>
      <li class="breadcrumb-item active">Creating a Rust Hello World Module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/rust/hello_world_module_rust.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="creating-a-rust-hello-world-module">
<h1>Creating a Rust Hello World Module<a class="headerlink" href="#creating-a-rust-hello-world-module" title="Permalink to this heading"></a></h1>
<blockquote>
<div><dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Shaun Loo</p>
</dd>
</dl>
</div></blockquote>
<section id="synopsis">
<h2>Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading"></a></h2>
<p>These steps outline how to modify the kernel source tree to include a new
“Hello, World!” kernel module in Rust. This module only performs the task
of printing a message to the console, but demonstrates a good amount of the
Rust workflow in the kernel, as well as getting a deep insight into the
current infrastructure available in the kernel for Rust support</p>
</section>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this heading"></a></h2>
<p>This tutorial assumes you already have a working virtual machine set up on our
<code class="docutils literal notranslate"><span class="pre">maize</span></code> server and that you are able to boot a kernel you have compiled
yourself on that VM. See our earlier tutorial on installing a custom kernel in a
VM if you have not already completed these tasks.</p>
<p>This tutorial also presumes that you have a working Rust toolchain on <code class="docutils literal notranslate"><span class="pre">maize</span></code>
Currently, the prefered way of getting such a toolchain is to install rustup
in your own user account. Visit
<a class="reference external" href="https://www.rust-lang.org/tools/install">this page</a> to get set up with a
toolchain.</p>
</section>
<section id="obtaining-the-source-code">
<h2>Obtaining the Source Code<a class="headerlink" href="#obtaining-the-source-code" title="Permalink to this heading"></a></h2>
<p>You will need to clone the kernel source tree again. The last two versions of
the Linux kernel since the Fall tutorials have added heaps in terms of Rust
support.</p>
<p>Remember, to make a shallow clone of the Linux kernel source:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--depth<span class="o">=</span><span class="m">1</span><span class="w"> </span>git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</pre></div>
</div>
</section>
<section id="setting-up-the-rust-toolchain-for-kernel-development">
<h2>Setting up the Rust toolchain for kernel development<a class="headerlink" href="#setting-up-the-rust-toolchain-for-kernel-development" title="Permalink to this heading"></a></h2>
<p><a class="reference external" href="https://docs.kernel.org/rust/quick-start.html#configuration">Adapted from here</a></p>
<p>Firstly, we check if Rust is even available</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>make<span class="w"> </span>defconfig
make<span class="w"> </span><span class="nv">LLVM</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>rustavailable
</pre></div>
</div>
<p>Invoking the build script with <code class="code docutils literal notranslate"><span class="pre">rustavailable</span></code> will test the current
configuration. It will report any incompatibilities with the current rustup
configuration.</p>
<p>For example, if you just installed <code class="code docutils literal notranslate"><span class="pre">rustup</span></code>, you might see an error
message like this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>***
***<span class="w"> </span>Rust<span class="w"> </span>compiler<span class="w"> </span><span class="s1">&#39;rustc&#39;</span><span class="w"> </span>is<span class="w"> </span>too<span class="w"> </span>new.<span class="w"> </span>This<span class="w"> </span>may<span class="w"> </span>or<span class="w"> </span>may<span class="w"> </span>not<span class="w"> </span>work.
***<span class="w">   </span>Your<span class="w"> </span>version:<span class="w">     </span><span class="m">1</span>.68.2
***<span class="w">   </span>Expected<span class="w"> </span>version:<span class="w"> </span><span class="m">1</span>.62.0
***
***
***<span class="w"> </span>Source<span class="w"> </span>code<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span><span class="s1">&#39;core&#39;</span><span class="w"> </span>standard<span class="w"> </span>library<span class="w"> </span>could<span class="w"> </span>not<span class="w"> </span>be<span class="w"> </span>found
***<span class="w"> </span>at<span class="w"> </span><span class="s1">&#39;/home/loo00013/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/lib.rs&#39;</span>.
***
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>Makefile:1825:<span class="w"> </span>rustavailable<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
</pre></div>
</div>
<p>We can’t go thru all the errors, so see the above link to find solutions
to each error. In this specific error, we see that the version of the
Rust compiler is too new. We fix this by telling rustup to override the
Rust compiler with the older version when you’re in the Linux kernel
source folder.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rustup<span class="w"> </span>override<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="k">$(</span>scripts/min-tool-version.sh<span class="w"> </span>rustc<span class="k">)</span>
</pre></div>
</div>
<p>Hopefully, at the end of this, you’ll get this output:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Rust<span class="w"> </span>is<span class="w"> </span>available!
</pre></div>
</div>
<p>This means we can move to the next step</p>
</section>
<section id="writing-the-kernel-module">
<h2>Writing the kernel module<a class="headerlink" href="#writing-the-kernel-module" title="Permalink to this heading"></a></h2>
<p>We will edit these files. If you’re not sure what
these files are, do review the earlier C hello world module tutorial.</p>
<p><code class="code docutils literal notranslate"><span class="pre">sample/rust/Kconfig</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">config</span> <span class="n">SAMPLE_RUST_HELLO</span>
   <span class="n">tristate</span> <span class="s2">&quot;Hello Module&quot;</span>
   <span class="n">help</span>
      <span class="n">This</span> <span class="n">option</span> <span class="n">builds</span> <span class="n">a</span> <span class="n">simple</span> <span class="n">Hello</span> <span class="n">World</span> <span class="n">module</span><span class="o">.</span>

      <span class="n">To</span> <span class="nb">compile</span> <span class="n">this</span> <span class="k">as</span> <span class="n">a</span> <span class="n">module</span><span class="p">,</span> <span class="n">choose</span> <span class="n">M</span> <span class="n">here</span><span class="p">:</span>
      <span class="n">the</span> <span class="n">module</span> <span class="n">wil</span> <span class="n">be</span> <span class="n">called</span> <span class="n">rust_hello</span><span class="o">.</span>

      <span class="n">If</span> <span class="n">unsure</span><span class="p">,</span> <span class="n">say</span> <span class="n">N</span><span class="o">.</span>

<span class="o">...</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">sample/rust/Makefile</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
obj-$(CONFIG_SAMPLE_RUST_HELLO)                      += rust_hello.o
...
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">sample/rust/hello.rs</span></code> (create this!)</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="c1">// SPDX-License-Identifier: GPL-2.0</span>

<span class="sd">//! Rust printing macros sample.</span>

<span class="k">use</span><span class="w"> </span><span class="n">kernel</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span>

<span class="n">module</span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">type</span>: <span class="nc">RustHello</span><span class="p">,</span>
<span class="w">   </span><span class="n">name</span>: <span class="s">&quot;rust_hello&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="n">author</span>: <span class="s">&quot;Rust for Linux Contributors&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="n">description</span>: <span class="s">&quot;Rust hello world sample&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="n">license</span>: <span class="s">&quot;GPL&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">RustHello</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">kernel</span>::<span class="n">Module</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RustHello</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">fn</span> <span class="nf">init</span><span class="p">(</span><span class="n">_module</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span> <span class="nc">ThisModule</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">pr_info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;-------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">pr_info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Vote Shaun for Vice Prez!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">pr_info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;-------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Building the kernel with the module!</p>
<p>In the kernel source folder, <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code></p>
<p>Enter General Setup, then navigate all the way to the bottom. You
should see <code class="code docutils literal notranslate"><span class="pre">[</span> <span class="pre">]</span> <span class="pre">Rust</span> <span class="pre">support</span></code>. Navigate to that item and hit
the spacebar. You should see a star next to it, indicating that Rust
support has been activated.</p>
<p>Hit Exit, then navigate to the Kernel Hacking section at the very bottom.
Find the entry <code class="code docutils literal notranslate"><span class="pre">[</span> <span class="pre">]</span> <span class="pre">Sample</span> <span class="pre">kernel</span> <span class="pre">code</span></code>. As with before, hit
the spacebar to activate the entry. Then, hit enter to enter the menu.</p>
<p>Scroll until you find <code class="code docutils literal notranslate"><span class="pre">[</span> <span class="pre">]</span> <span class="pre">Rust</span> <span class="pre">samples</span> <span class="pre">(NEW)</span></code>. Again, activate
the entry and enter it. You’ll see <cite>&lt; &gt; Hello Module (NEW)</cite>. Hit the
spacebar until you see the * indicating that it is activated (I have
not tested M yet).</p>
<p>Hit Save, and save the config as <code class="code docutils literal notranslate"><span class="pre">.config</span></code>, then exit the makeconfig
menu.</p>
<p>Now, invoke build with <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">LLVM=1</span> <span class="pre">-j16</span></code>. We need the flag
<code class="code docutils literal notranslate"><span class="pre">LLVM=1</span></code> because the Rust compiler uses the LLVM backend and
integrating Rust code with a <code class="code docutils literal notranslate"><span class="pre">clang</span></code>-built kernel (which uses
the LLVM backend) is easier.</p>
<p>Hopefully, this compiles without issues. The final step is to install
the kernel in your VM. Refer to the previous tutorial for instructions
on that.</p>
<p>When booting into the kernel, you should see a cute little message
fly by if you’re quick enough. If you’re not, however, type
<code class="code docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">journalctl</span> <span class="pre">-b</span></code> and you should be able to scroll thru
it and find it!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="hello_world_module.html" class="btn btn-neutral float-left" title="Creating a Hello World Kernel Module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="caesar_module.html" class="btn btn-neutral float-right" title="Creating a Simple Encryption Module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>